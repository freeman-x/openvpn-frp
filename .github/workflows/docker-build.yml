# å·¥ä½œæµçš„åç§°ï¼ŒGitHub ä¸Šæ˜¾ç¤ºä¸º â€œBuild and Push Multi-Arch Docker Imageâ€
name: Build and Push Multi-Arch Docker Image

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # è§¦å‘æ¡ä»¶1ï¼špush åˆ° main åˆ†æ”¯ï¼Œå¹¶ä¸” docker æ–‡ä»¶å¤¹å†…æˆ–è€… workflow é…ç½®æ–‡ä»¶æœ¬èº«æœ‰ä¿®æ”¹
  push:
    branches:
      - main  # ä»…å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
    paths:
      - 'docker/**'  # ä»…å½“ docker æ–‡ä»¶å¤¹å†…æ–‡ä»¶å‘ç”Ÿæ›´æ”¹æ—¶è§¦å‘
      - '.github/workflows/docker-build.yml'  # æˆ–è€…è¯¥å·¥ä½œæµæ–‡ä»¶æœ¬èº«æœ‰ä¿®æ”¹æ—¶è§¦å‘

  # è§¦å‘æ¡ä»¶2ï¼šæ‰‹åŠ¨è¿è¡Œå·¥ä½œæµ
  workflow_dispatch:

# è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åœ¨åç»­çš„æ­¥éª¤ä¸­ä½¿ç”¨
env:
  IMAGE_NAME: openvpn-frp  # é•œåƒåç§°
  DOCKERFILE_PATH: docker/Dockerfile  # Dockerfile è·¯å¾„
  CONTEXT: ./docker  # æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„ï¼ˆå³å­˜æ”¾ Dockerfile çš„æ–‡ä»¶å¤¹ï¼‰
  VERSION: v1.1  # å½“å‰é•œåƒçš„ç‰ˆæœ¬å·ï¼ˆå¯ä»¥ä¿®æ”¹ä¸ºä¸åŒç‰ˆæœ¬å·ï¼‰

# ä»»åŠ¡å®šä¹‰ï¼šè¿™æ˜¯æ„å»ºå’Œæ¨é€ Docker é•œåƒçš„æ­¥éª¤
jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒè¿›è¡Œæ„å»º

    steps:
      # æ­¥éª¤1ï¼šä» GitHub ä»“åº“ä¸­æ‹‰å–ä»£ç 
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3  # ä½¿ç”¨å®˜æ–¹çš„ checkout åŠ¨ä½œæ‹‰å–ä»£ç 

      # æ­¥éª¤2ï¼šç™»å½•åˆ° Docker Hub
      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v3  # ä½¿ç”¨ Docker å®˜æ–¹çš„ç™»å½•åŠ¨ä½œ
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub ç”¨æˆ·åï¼ˆéœ€é…ç½®ä¸º GitHub secretsï¼‰
          password: ${{ secrets.DOCKER_PASSWORD }}     # Docker Hub Tokenï¼ˆå»ºè®®ä½¿ç”¨ token è€Œéå¯†ç ï¼‰

      # æ­¥éª¤3ï¼šè®¾ç½® Docker Buildxï¼ˆå¯ç”¨å¤šå¹³å°æ„å»ºï¼‰
      - name: ğŸ› ï¸ Set up Docker Buildx (æ”¯æŒå¤šå¹³å°æ„å»º)
        uses: docker/setup-buildx-action@v3  # ä½¿ç”¨å®˜æ–¹çš„ Buildx è®¾ç½®åŠ¨ä½œï¼Œå¯ç”¨å¤šå¹³å°æ„å»ºåŠŸèƒ½

      # æ­¥éª¤4ï¼šæ„å»ºå¹¶æ¨é€å¤šå¹³å° Docker é•œåƒ
      - name: ğŸ“¦ Build and Push Multi-Platform Image
        uses: docker/build-push-action@v5  # ä½¿ç”¨å®˜æ–¹çš„æ„å»ºå’Œæ¨é€åŠ¨ä½œ
        with:
          context: ${{ env.CONTEXT }}  # æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„ï¼ŒæŒ‡å‘åŒ…å« Dockerfile çš„ç›®å½•
          file: ${{ env.DOCKERFILE_PATH }}  # æŒ‡å®š Dockerfile è·¯å¾„
          push: true  # æ„å»ºå®Œæˆåï¼Œè‡ªåŠ¨å°†é•œåƒæ¨é€åˆ° Docker Hub
          platforms: linux/amd64,linux/arm64  # æ„å»ºæ”¯æŒçš„å¤šå¹³å°ï¼ˆamd64 å’Œ arm64ï¼‰
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest  # æ¨é€ latest æ ‡ç­¾
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}  # æ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¾‹å¦‚ v1.1ï¼‰

      # æ­¥éª¤5ï¼šæ‰“å°å®Œæˆä¿¡æ¯ï¼Œè¡¨ç¤ºå·¥ä½œæµæ‰§è¡ŒæˆåŠŸ
      - name: âœ… Done
        run: echo "âœ… Image ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v1.1 & latest built and pushed!"  # æ‰“å°æ¨é€æˆåŠŸçš„ä¿¡æ¯
